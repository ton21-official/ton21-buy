<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T21 Wallet — Mini App</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root {
      --bg: #0b0b0f;
      --panel: #13131a;
      --gold: #f0d173;
      --gold-2: #ffe794;
      --text: #e9e9e9;
      --muted: #9aa0a6;
      --danger: #ff6b6b;
      --ok: #27d980;
      --btn-shadow: 0 6px 20px rgba(240,209,115,.15);
      --radius: 14px;
    }
    * { box-sizing: border-box }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font: 16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .wrap { max-width: 920px; margin: 22px auto 80px; padding: 0 14px; }
    .hero { text-align:center; margin-bottom: 18px; }
    .logo-wrap {
      width:108px; height:108px; margin:10px auto 12px; border-radius:50%;
      background: radial-gradient(60% 60% at 50% 50%, rgba(240,209,115,.35), rgba(0,0,0,0));
      display:grid; place-items:center;
    }
    .logo {
      width:92px; height:92px; border-radius:50%; border:2px solid var(--gold);
      background:#000 center/cover no-repeat;
      background-image:url("https://raw.githubusercontent.com/ton21-official/ton21-logo/main/t21_logo_gold.png");
      box-shadow: 0 0 28px rgba(240,209,115,.35);
    }
    h1 {
      margin:0 0 6px; font-weight:800; letter-spacing:.2px;
      text-shadow: 0 0 24px rgba(240,209,115,.25);
      color: var(--gold);
      font-size: clamp(22px, 4.8vw, 30px);
    }
    .sub { color:#cfcfcf; font-size:15px; text-align:center; margin:0 8px 18px }
    .card {
      background:var(--panel); border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius); padding:18px; margin: 0 auto 16px; max-width:780px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .input {
      flex:1 1 520px; background:#0e0e14; color:var(--text);
      border:1px solid rgba(255,255,255,.08);
      padding:14px 14px; border-radius: 10px; outline:none;
      font-size:15px;
    }
    .input::placeholder{ color:#7d8590 }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      background:var(--gold); color:#0b0b0f; border:0; border-radius:10px;
      padding:12px 16px; font-weight:700; cursor:pointer;
      box-shadow: var(--btn-shadow); transition:.2s transform,.2s background;
      min-width:132px;
    }
    .btn:hover { background:var(--gold-2); transform: translateY(-1px) }
    .pill { background:#0e0e14; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 12px; }
    .stat {
      display:flex; gap:10px; justify-content:space-between; text-align:center;
      background:#0e0e14; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px; margin-top:12px;
    }
    .stat > div { flex:1 }
    .label { color:var(--muted); font-size:12px; letter-spacing:.3px }
    .value { font-size:20px; font-weight:800; margin-top:6px }
    .ok { color: var(--ok) }
    .err { color: var(--danger) }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr }
    @media (min-width:680px){ .grid { grid-template-columns: 1fr 1fr } }
    .cta .btn { width:100% }
    .langbar{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; color:#aab0b8; }
    .langbar button{
      border:1px solid var(--gold); color:var(--gold); background:transparent;
      padding:6px 10px; border-radius:8px; cursor:pointer; min-width:44px; font-weight:700
    }
    footer { text-align:center; color:#7f8691; margin-top:18px; font-size:13px }
    .hint { font-size:12px; color:#a2a8b3; margin-top:8px; text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo-wrap"><div class="logo"></div></div>
      <h1 id="t-title">✨ Welcome to T21 Wallet ✨</h1>
      <p class="sub" id="t-sub">💎 Your decentralized gateway to the Ton21 ecosystem.</p>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="addr" class="input" placeholder="Paste Tonkeeper address (starts with UQ or EQ)" />
        <button id="save" class="btn">💾 <span id="t-save">Save</span></button>
      </div>

      <div class="row" style="margin-bottom:8px">
        <button id="refresh" class="btn">🔄 <span id="t-refresh">Refresh</span></button>
        <div id="status" class="pill" style="flex:1; text-align:center;"></div>
      </div>

      <div class="stat">
        <div>
          <div class="label">TON</div>
          <div id="ton" class="value">—</div>
        </div>
        <div>
          <div class="label">T21</div>
          <div id="t21" class="value">—</div>
        </div>
      </div>

      <div class="hint" id="t-hint">Enter Tonkeeper address (starts with UQ or EQ)</div>
    </div>

    <div class="card cta">
      <div class="grid" style="margin-bottom:8px">
        <a class="btn" id="buyBtn">💰 <span id="t-buy">Buy $T21</span></a>
        <a class="btn" id="swapBtn">🔁 <span id="t-swap">Swap / Exchange</span></a>
      </div>
      <div class="grid">
        <a class="btn" id="portalBtn">🌐 <span id="t-portal">Ton21 Portal</span></a>
        <a class="btn" id="assistantBtn">🪙 <span id="t-assistant">Buy Assistant</span></a>
      </div>
      <div class="langbar">
        🌐 <span id="t-language">Language:</span>
        <button data-lang="ru">RU</button>
        <button data-lang="en">GB</button>
        <button data-lang="zh">CN</button>
        <button data-lang="hi">IN</button>
      </div>
    </div>

    <footer>© 2025 Ton21 Project — All rights reserved</footer>
  </div>

  <script>
    // ─────────────────────────────────────────────────────────────────────────
    // 0) Telegram Mini App init + helpers
    // ─────────────────────────────────────────────────────────────────────────
    (function initWA(){
      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
        }
      } catch(e){}
    })();

    function openLink(url){
      try{
        if (window.Telegram && Telegram.WebApp) return Telegram.WebApp.openLink(url);
      }catch(e){}
      window.open(url, "_blank");
    }

    // ─────────────────────────────────────────────────────────────────────────
    // 1) Settings
    // ─────────────────────────────────────────────────────────────────────────
    const T21_MASTER = "EQBLgiPMly982IMGqauqdX0Fe_N01arD-LhlKSfxBd8rzYRG";
    // Вставь свой ключ (опционально). Можно оставить пустым — будет паблик доступ.
    const TONCENTER_KEY = "6c157ea65ec504b0aa2d83c2f68efe872f796755bf1445b1e5168da2e452b83a".trim();

    const LINKS = {
      BUY:   "https://dedust.io/swap/TON/T21",
      SWAP:  "https://dedust.io/swap/T21/TON",
      PORTAL:"https://t.me/Ton21PortalBot",
      ASSIST:"https://t.me/T21BuyBot"
    };

    // ─────────────────────────────────────────────────────────────────────────
    // 2) i18n
    // ─────────────────────────────────────────────────────────────────────────
    const I18N = {
      en: {
        title:"✨ Welcome to T21 Wallet ✨",
        sub:"💎 Your decentralized gateway to the Ton21 ecosystem.",
        save:"Save", refresh:"Refresh",
        hint:"Enter Tonkeeper address (starts with UQ or EQ)",
        buy:"Buy $T21", swap:"Swap / Exchange", portal:"Ton21 Portal", assistant:"Buy Assistant",
        language:"Language:",
        savedOk:"✅ Address saved", wrong:"⚠️ Invalid address",
        loading:"⏳ Loading…", netbusy:"⚠️ Network is busy, try again later",
        noaddr:"⚠️ Add address first"
      },
      ru: {
        title:"✨ Добро пожаловать в T21 Кошелёк ✨",
        sub:"💎 Твой децентрализованный портал в экосистему Ton21.",
        save:"Сохранить", refresh:"Обновить",
        hint:"Вставь Tonkeeper-адрес (начинается с UQ или EQ)",
        buy:"Купить $T21", swap:"Обмен / Swap", portal:"Портал Ton21", assistant:"Помощник покупки",
        language:"Язык:",
        savedOk:"✅ Адрес сохранён", wrong:"⚠️ Некорректный адрес",
        loading:"⏳ Загрузка…", netbusy:"⚠️ Сеть перегружена, попробуйте позже",
        noaddr:"⚠️ Сначала добавьте адрес"
      },
      zh: {
        title:"✨ 欢迎使用 T21 钱包 ✨",
        sub:"💎 进入 Ton21 生态系统的去中心化门户。",
        save:"保存", refresh:"刷新",
        hint:"粘贴 Tonkeeper 地址（以 UQ 或 EQ 开头）",
        buy:"购买 $T21", swap:"代币交换", portal:"Ton21 门户", assistant:"购买助手",
        language:"语言：",
        savedOk:"✅ 地址已保存", wrong:"⚠️ 地址无效",
        loading:"⏳ 载入中…", netbusy:"⚠️ 网络繁忙，请稍后重试",
        noaddr:"⚠️ 请先添加地址"
      },
      hi: {
        title:"✨ T21 वॉलेट में आपका स्वागत है ✨",
        sub:"💎 Ton21 पारिस्थितिकी तंत्र का आपका विकेंद्रीकृत प्रवेश द्वार।",
        save:"सहेजें", refresh:"रीफ़्रेश",
        hint:"Tonkeeper पता दर्ज करें (UQ या EQ से शुरू)",
        buy:"$T21 खरीदें", swap:"टोकन स्वैप", portal:"Ton21 पोर्टल", assistant:"खरीद सहायक",
        language:"भाषा:",
        savedOk:"✅ पता सहेजा गया", wrong:"⚠️ अमान्य पता",
        loading:"⏳ लोड हो रहा है…", netbusy:"⚠️ नेटवर्क व्यस्त है, बाद में प्रयास करें",
        noaddr:"⚠️ पहले पता जोड़ें"
      }
    };
    const els = {
      title:    document.getElementById("t-title"),
      sub:      document.getElementById("t-sub"),
      save:     document.getElementById("t-save"),
      refresh:  document.getElementById("t-refresh"),
      hint:     document.getElementById("t-hint"),
      buy:      document.getElementById("t-buy"),
      swap:     document.getElementById("t-swap"),
      portal:   document.getElementById("t-portal"),
      assist:   document.getElementById("t-assistant"),
      langlab:  document.getElementById("t-language"),
      addr:     document.getElementById("addr"),
      status:   document.getElementById("status"),
      ton:      document.getElementById("ton"),
      t21:      document.getElementById("t21"),
      saveBtn:  document.getElementById("save"),
      refreshBtn: document.getElementById("refresh"),
      buyBtn:   document.getElementById("buyBtn"),
      swapBtn:  document.getElementById("swapBtn"),
      portalBtn:document.getElementById("portalBtn"),
      assistantBtn:document.getElementById("assistantBtn"),
    };

    function setLang(lang){
      const t = I18N[lang] || I18N.en;
      els.title.textContent = t.title;
      els.sub.textContent = t.sub;
      els.save.textContent = t.save;
      els.refresh.textContent = t.refresh;
      els.hint.textContent = t.hint;
      els.buy.textContent = t.buy;
      els.swap.textContent = t.swap;
      els.portal.textContent = t.portal;
      els.assist.textContent = t.assistant;
      els.langlab.textContent = t.language;
      localStorage.setItem("t21_lang", lang);
    }
    document.querySelectorAll(".langbar button").forEach(b=>{
      b.addEventListener("click", ()=> setLang(b.dataset.lang));
    });

    // ─────────────────────────────────────────────────────────────────────────
    // 3) Links
    // ─────────────────────────────────────────────────────────────────────────
    els.buyBtn.onclick      = ()=> openLink(LINKS.BUY);
    els.swapBtn.onclick     = ()=> openLink(LINKS.SWAP);
    els.portalBtn.onclick   = ()=> openLink(LINKS.PORTAL);
    els.assistantBtn.onclick= ()=> openLink(LINKS.ASSIST);

    // ─────────────────────────────────────────────────────────────────────────
    // 4) Balances (Toncenter → alt Toncenter → TON API)
    // ─────────────────────────────────────────────────────────────────────────
    async function httpGet(url){
      const res = await fetch(url, {method:"GET"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json();
    }

    function fmtTON(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:4}) }
    function fmtT21(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}) }

    async function toncenterBalance(addr){
      const base = "https://toncenter.com/api/v2";
      const keyQ = TONCENTER_KEY ? `&api_key=${encodeURIComponent(TONCENTER_KEY)}` : "";
      const a = await httpGet(`${base}/getAddressBalance?address=${addr}${keyQ}`);
      const ton = (a.result? Number(a.result)/1e9 : 0);

      // Jetton (T21)
      let t21 = 0;
      try{
        const j = await httpGet(`${base}/get_jetton_wallet_info?address=${addr}&jetton_master=${T21_MASTER}${keyQ}`);
        if (j.result && j.result.balance) t21 = Number(j.result.balance)/1e9;
      }catch(e){ /* not created → 0 */ }

      return {ton, t21};
    }

    async function toncenterAlt(addr){
      // зеркальный хост (на случай перегрузки основного)
      const base = "https://toncenter.com/api/v2"; // можно заменить на свой зеркальный узел
      const keyQ = TONCENTER_KEY ? `&api_key=${encodeURIComponent(TONCENTER_KEY)}` : "";
      const a = await httpGet(`${base}/getAddressBalance?address=${addr}${keyQ}`);
      const ton = (a.result? Number(a.result)/1e9 : 0);

      let t21 = 0;
      try{
        const j = await httpGet(`${base}/get_jetton_wallet_info?address=${addr}&jetton_master=${T21_MASTER}${keyQ}`);
        if (j.result && j.result.balance) t21 = Number(j.result.balance)/1e9;
      }catch(e){}
      return {ton, t21};
    }

    async function tonapiBalance(addr){
      // публичный TON API
      const a = await httpGet(`https://tonapi.io/v2/accounts/${addr}`);
      const ton = a.balance? Number(a.balance)/1e9 : 0;

      let t21 = 0;
      try{
        const j = await httpGet(`https://tonapi.io/v2/accounts/${addr}/jettons`);
        if (Array.isArray(j.balances)) {
          const hit = j.balances.find(b => (b.jetton && (b.jetton.address===T21_MASTER)));
          if (hit) {
            // у них баланс может быть строкой в наноджеттонах:
            const raw = hit.balance ?? 0;
            t21 = Number(raw)/1e9;
          }
        }
      }catch(e){}
      return {ton, t21};
    }

    async function loadBalances(addr){
      const lang = localStorage.getItem("t21_lang") || "ru";
      const T = I18N[lang] || I18N.en;
      els.status.textContent = T.loading;
      els.status.style.color = "";

      try {
        // 1) основной toncenter
        return await toncenterBalance(addr);
      } catch (e1) {
        try {
          // 2) альтернативный (можно заменить на свой прокси/нод)
          return await toncenterAlt(addr);
        } catch (e2) {
          // 3) тон-апи
          try{
            return await tonapiBalance(addr);
          }catch(e3){
            throw e3;
          }
        }
      }
    }

    async function refresh(){
      const lang = localStorage.getItem("t21_lang") || "ru";
      const T = I18N[lang] || I18N.en;
      const addr = (els.addr.value||"").trim();

      if (!/^(UQ|EQ)/.test(addr) || addr.length < 36){
        els.status.textContent = T.wrong;
        els.status.className = "pill err";
        return;
      }

      els.status.textContent = T.loading;
      els.status.className = "pill";

      try{
        const {ton, t21} = await loadBalances(addr);
        els.ton.textContent = fmtTON(ton);
        els.t21.textContent = fmtT21(t21);
        els.status.textContent = "✅ OK";
        els.status.className = "pill ok";
      }catch(err){
        els.status.textContent = T.netbusy;
        els.status.className = "pill err";
        els.ton.textContent = "—";
        els.t21.textContent = "—";
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // 5) Save / Restore / Events
    // ─────────────────────────────────────────────────────────────────────────
    function saveAddr(){
      const lang = localStorage.getItem("t21_lang") || "ru";
      const T = I18N[lang] || I18N.en;
      const a = (els.addr.value||"").trim();
      if (!/^(UQ|EQ)/.test(a) || a.length < 36){
        els.status.textContent = T.wrong;
        els.status.className = "pill err";
        return;
      }
      localStorage.setItem("t21_addr", a);
      els.status.textContent = T.savedOk;
      els.status.className = "pill ok";
    }

    els.saveBtn.addEventListener("click", saveAddr);
    els.refreshBtn.addEventListener("click", refresh);
    els.addr.addEventListener("keydown", (e)=>{ if(e.key==="Enter") saveAddr() });

    // ─────────────────────────────────────────────────────────────────────────
    // 6) Boot
    // ─────────────────────────────────────────────────────────────────────────
    (function boot(){
      const lang = localStorage.getItem("t21_lang") || "ru";
      setLang(lang);

      const a = localStorage.getItem("t21_addr");
      if (a) els.addr.value = a;

      // Авто-обновление при наличии адреса
      if (a) refresh();
      
      // кнопки — это ссылки, но открываем через Telegram
      document.querySelectorAll("a.btn").forEach(a=>{
        const id = a.id;
        a.href = "javascript:void(0)";
      });
    })();
  </script>
</body>
</html>
